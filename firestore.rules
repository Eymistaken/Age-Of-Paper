rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Yardımcı Fonksiyonlar
    function isPlayer(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    function isTurnOwner() {
      // Turn Index sınırlarını kontrol et ve sıranın oyuncuda olduğunu doğrula
      return resource.data.turnOrder.size() > 0 &&
             resource.data.turnIndex >= 0 &&
             resource.data.turnIndex < resource.data.turnOrder.size() &&
             resource.data.turnOrder[resource.data.turnIndex] == request.auth.uid;
    }

    match /rooms/{roomCode} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null 
                    && request.resource.data.hostId == request.auth.uid
                    && request.resource.data.players[request.auth.uid].money == 0; // Başlangıç parası 0 olmalı

      allow update: if request.auth != null && (
        
        // 1. OYUNCU VERİSİ İZOLASYONU
        // Sadece kendi player verisini değiştirebilir/ekleyebilir.
        request.resource.data.players.diff(resource.data.players).affectedKeys().hasOnly([request.auth.uid])
        
        && (
          // OYUNCU MEVCUT MU? (JOIN VS PLAY)
          (request.auth.uid in resource.data.players) 
          ? (
            // === MEVCUT OYUNCU İŞLEMLERİ ===

            // 2. GELİR KONTROLÜ (MONEY INCREASE)
            (request.resource.data.players[request.auth.uid].money > resource.data.players[request.auth.uid].money) 
            ? (
                (resource.data.turnOrder.size() == 1 || request.resource.data.turnIndex != resource.data.turnIndex) &&
                (request.resource.data.players[request.auth.uid].money - resource.data.players[request.auth.uid].money) <= 50000
              ) 
            : true
            
            &&
            
            // 3. HARCAMA TUTARLILIĞI (MONEY DECREASE)
            ((resource.data.players[request.auth.uid].money > request.resource.data.players[request.auth.uid].money) 
            ? (
                // DURUM A: Asker Üretimi
                (
                  (resource.data.players[request.auth.uid].money - request.resource.data.players[request.auth.uid].money) == 10000 &&
                  request.resource.data.players[request.auth.uid].reserve == resource.data.players[request.auth.uid].reserve + 1000
                )
                ||
                // DURUM B: Liman İnşası
                (
                  (resource.data.players[request.auth.uid].money - request.resource.data.players[request.auth.uid].money) == 90000 &&
                  request.resource.data.gameData != resource.data.gameData
                )
                ||
                // DURUM C: Toprak Satın Alma
                (
                  request.resource.data.gameData != resource.data.gameData
                )
              )
            : true)

            &&
            
            // 4. OYUN YAPISI VE SIRA KONTROLÜ
            ((request.resource.data.gameData != resource.data.gameData) 
            ? isTurnOwner() 
            : true)

          ) 
          : (
            // === YENİ KATILAN OYUNCU (JOIN) ===
            // Katılırken para 0 olmalı
            request.resource.data.players[request.auth.uid].money == 0
          )
        )
      );
      
      allow delete: if request.auth != null && resource.data.hostId == request.auth.uid;
    }
  }
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age of Paper - Online</title>
    
    <!-- React ve Gerekli K√ºt√ºphaneler -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #2c3e50; color: white; margin: 0; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2c3e50; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        
        .port-icon { pointer-events: none; text-shadow: 0 0 2px black; fill: white; text-anchor: middle; dominant-baseline: middle; font-size: 12px; }
        .owned-player { fill: var(--owner-color) !important; stroke: #333; stroke-width: 1px; }
        .default-land { fill: #ececec; stroke: #555; stroke-width: 0.5px; transition: fill 0.2s; cursor: pointer; }
        .default-land:hover { fill: #bdc3c7; }
        .selected { stroke: #f1c40f !important; stroke-width: 3px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ==================================================================
        // SENƒ∞N PROJE AYARLARIN (Eymistaken)
        // ==================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyC3_3GnZIv78PEVsLGjSv_k31ai8fZjmL8",
          authDomain: "eymistaken.firebaseapp.com",
          projectId: "eymistaken",
          storageBucket: "eymistaken.firebasestorage.app",
          messagingSenderId: "677072278270",
          appId: "1:677072278270:web:6bfbd792b01eb1dc6e0baf",
          measurementId: "G-PJECZ871LP"
        };

        // Firebase Ba≈ülat
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ƒ∞KONLAR ---
        const Icon = ({ children, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Loader = ({ size, className }) => <Icon size={size} className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;
        const Copy = ({ size, className, onClick }) => <span onClick={onClick} style={{cursor:'pointer'}}><Icon size={size} className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon></span>;
        const LogOut = ({ size }) => <Icon size={size}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>;
        const Shield = ({ size, className }) => <Icon size={size} className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></Icon>;
        const Users = ({ size, className }) => <Icon size={size} className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const MessageSquare = ({ size, className }) => <Icon size={size} className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>;
        const Send = ({ size }) => <Icon size={size}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></Icon>;

        const PLAYER_COLORS = ['#3498db', '#e74c3c', '#f1c40f', '#9b59b6', '#2ecc71', '#1abc9c', '#d35400'];
        
        const nameMapping = {
            "Turkey": "TR", "United States": "US", "USA": "US", "Russia": "RU", "Russian Federation": "RU", "China": "CN",
            "Germany": "DE", "France": "FR", "United Kingdom": "GB", "Great Britain": "GB", "UK": "GB",
            "Italy": "IT", "Spain": "ES", "Portugal": "PT", "Brazil": "BR", "Brasil": "BR", "Azerbaijan": "AZ", "Greece": "GR", "Japan": "JP"
        };
        const definedCountries = {
            "TR": { name: "T√ºrkiye", cost: 60000, income: 5000 },
            "US": { name: "ABD", cost: 150000, income: 12000 },
            "RU": { name: "Rusya", cost: 120000, income: 9000 },
            "CN": { name: "√áin", cost: 130000, income: 10000 },
            "DE": { name: "Almanya", cost: 90000, income: 7500 },
            "FR": { name: "Fransa", cost: 85000, income: 7000 },
            "GB": { name: "ƒ∞ngiltere", cost: 88000, income: 7200 },
            "IT": { name: "ƒ∞talya", cost: 70000, income: 6000 },
            "ES": { name: "ƒ∞spanya", cost: 65000, income: 5500 },
            "PT": { name: "Portekiz", cost: 40000, income: 3500 },
            "BR": { name: "Brezilya", cost: 75000, income: 6000 },
            "AZ": { name: "Azerbaycan", cost: 45000, income: 4000 },
            "GR": { name: "Yunanistan", cost: 40000, income: 3000 },
            "JP": { name: "Japonya", cost: 80000, income: 7000 }
        };

        const { useState, useEffect, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [gameState, setGameState] = useState('login');
            const [roomCode, setRoomCode] = useState('');
            const [nickname, setNickname] = useState(localStorage.getItem('aop_nickname') || '');
            const [roomData, setRoomData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [connStatus, setConnStatus] = useState('Baƒülanƒ±yor...');

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                    } else {
                        setConnStatus('Giri≈ü yapƒ±lƒ±yor...');
                        signInAnonymously(auth)
                            .catch(e => {
                                console.error(e);
                                setConnStatus('Baƒülantƒ± Hatasƒ±: ' + e.message);
                            });
                    }
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!roomCode || !user) return;
                
                // Oda verisi dinleme
                const roomRef = doc(db, 'rooms', roomCode);
                const unsub = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setRoomData(data);
                        if (data.players && data.players[user.uid]) {
                            setGameState('game');
                            localStorage.setItem('aop_room', roomCode);
                        } else if (gameState === 'game') {
                            leaveRoom(true); // Atƒ±ldƒ±n veya silindi
                        }
                    } else if (gameState === 'game') {
                        leaveRoom(true); // Oda yok
                    }
                }, (err) => {
                    console.error("Oda hatasƒ±:", err);
                    setError("Oda verisi okunamadƒ±.");
                });
                return () => unsub();
            }, [roomCode, user, gameState]);

            const createRoom = async () => {
                if (!nickname) return setError("ƒ∞sim girin.");
                setLoading(true);
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                const roomRef = doc(db, 'rooms', code);
                
                const initialData = {
                    hostId: user.uid, status: 'lobby', mapSvg: '',
                    players: { [user.uid]: { id: user.uid, name: nickname, color: PLAYER_COLORS[0], money: 50000, soldiers: 0 } },
                    chat: [], gameData: {}
                };
                
                try {
                    await setDoc(roomRef, initialData);
                    setRoomCode(code);
                    localStorage.setItem('aop_nickname', nickname);
                    setGameState('game');
                } catch (e) { setError("Hata: " + e.message); }
                setLoading(false);
            };

            const joinRoom = async (code) => {
                if (!nickname || !code) return setError("Bilgileri kontrol edin.");
                setLoading(true);
                const roomRef = doc(db, 'rooms', code);
                
                try {
                    const snap = await getDoc(roomRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        const idx = Object.keys(data.players || {}).length;
                        const color = PLAYER_COLORS[idx % PLAYER_COLORS.length];
                        
                        await updateDoc(roomRef, {
                            [`players.${user.uid}`]: { id: user.uid, name: nickname, color, money: 50000, soldiers: 0 }
                        });
                        setRoomCode(code);
                        localStorage.setItem('aop_nickname', nickname);
                        setGameState('game');
                    } else { setError("Oda bulunamadƒ±."); }
                } catch (e) { setError("Hata: " + e.message); }
                setLoading(false);
            };

            const leaveRoom = async (forced) => {
                if (!forced && roomCode && user) {
                    try {
                        const roomRef = doc(db, 'rooms', roomCode);
                        await updateDoc(roomRef, { [`players.${user.uid}`]: deleteField() });
                    } catch(e) { console.log(e); }
                }
                setRoomCode(''); setRoomData(null); setGameState('login'); localStorage.removeItem('aop_room');
            };

            if (!user) return (
                <div className="flex flex-col h-screen items-center justify-center text-white bg-gray-900">
                    <Loader size={48} className="animate-spin mb-4 text-yellow-500"/>
                    <p className="text-lg">{connStatus}</p>
                    <p className="text-sm text-gray-500 mt-2">Veritabanƒ±na eri≈üiliyor...</p>
                </div>
            );

            if (gameState === 'login') {
                return (
                    <div className="flex flex-col items-center justify-center h-full p-4 space-y-6">
                        <h1 className="text-5xl font-bold text-yellow-500 mb-4" style={{ fontFamily: 'Georgia, serif' }}>Age of Paper</h1>
                        <div className="bg-gray-700 p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-600">
                            {error && <div className="bg-red-500/20 text-red-300 p-3 rounded mb-4 text-sm">{error}</div>}
                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2 text-gray-300">ƒ∞sminiz</label>
                                <input type="text" value={nickname} onChange={(e) => setNickname(e.target.value)} className="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white focus:border-yellow-500 outline-none" placeholder="Komutan Adƒ±" maxLength={15}/>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={createRoom} disabled={loading} className="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded flex items-center justify-center">
                                    {loading ? <Loader size={20} className="animate-spin"/> : "Oda Kur"}
                                </button>
                                <div className="relative">
                                    <input type="text" placeholder="KOD" id="joinCodeInput" className="w-full bg-gray-900 border border-gray-600 rounded-l p-3 text-white text-center uppercase tracking-widest" maxLength={4}/>
                                    <button onClick={() => joinRoom(document.getElementById('joinCodeInput').value.toUpperCase())} disabled={loading} className="absolute right-0 top-0 bottom-0 bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 rounded-r">Katƒ±l</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            return <GameRoom user={user} roomCode={roomCode} roomData={roomData} leaveRoom={() => leaveRoom()} />;
        }

        function GameRoom({ user, roomCode, roomData, leaveRoom }) {
            const [scale, setScale] = useState(1);
            const [pos, setPos] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            const [selectedId, setSelectedId] = useState(null);
            const [msg, setMsg] = useState('');
            const [tab, setTab] = useState('chat');
            
            const me = roomData.players[user.uid] || {};
            const isHost = roomData.hostId === user.uid;
            const svgRef = useRef(null);

            // ZOOM FIX BURADA
            const handleWheel = (e) => {
                const factor = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.max(0.5, Math.min(20, scale * factor));
                const rect = e.currentTarget.getBoundingClientRect();
                
                // HATA BURADAYDI: mx yerine mouseX kullandƒ±m
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const worldX = (mouseX - pos.x) / scale;
                const worldY = (mouseY - pos.y) / scale;
                
                setPos({ x: mouseX - worldX * newScale, y: mouseY - worldY * newScale });
                setScale(newScale);
            };
            
            const startDrag = (e) => { if(e.button===0){ setIsDragging(true); setDragStart({x: e.clientX - pos.x, y: e.clientY - pos.y}); }};
            const doDrag = (e) => { if(isDragging) setPos({x: e.clientX - dragStart.x, y: e.clientY - dragStart.y}); };
            const stopDrag = () => setIsDragging(false);

            const updateRoom = async (data) => await updateDoc(doc(db, 'rooms', roomCode), data);

            const handleMap = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => updateRoom({ mapSvg: ev.target.result });
                r.readAsText(f);
            };

            const sendMsg = (e) => {
                e.preventDefault();
                if(!msg.trim()) return;
                updateRoom({ chat: arrayUnion({ sender: me.name, color: me.color, text: msg, time: Date.now() }) });
                setMsg('');
            };

            const buyRegion = () => {
                if(!selectedId) return;
                const cost = 10000;
                updateDoc(doc(db, 'rooms', roomCode), {
                    [`players.${user.uid}.money`]: me.money - cost,
                    [`gameData.${selectedId}`]: { owner: user.uid, ownerName: me.name, color: me.color }
                });
            };

            useEffect(() => {
                if(svgRef.current && roomData.mapSvg) {
                    const paths = svgRef.current.querySelectorAll('path, circle, polygon');
                    paths.forEach((p, idx) => {
                        let id = p.getAttribute('id');
                        if(!id) { id = 'r_'+idx; p.setAttribute('id', id); }
                        
                        const region = roomData.gameData[id];
                        const color = region ? region.color : '#ececec';
                        
                        p.style.fill = color;
                        p.style.stroke = '#555';
                        p.style.strokeWidth = '0.5px';
                        p.classList.add('default-land');
                        
                        p.onclick = (e) => { e.stopPropagation(); setSelectedId(id); };
                    });
                }
            }, [roomData.mapSvg, roomData.gameData]);

            let regionInfo = { name: selectedId, status: 'Sahipsiz' };
            if(selectedId) {
                let rawName = document.getElementById(selectedId)?.getAttribute('name') || selectedId;
                if(rawName && typeof rawName === 'string') {
                    rawName = rawName.replace(/default-land/g, "").replace(/_/g, " ").trim();
                }
                
                if(definedCountries[selectedId]) rawName = definedCountries[selectedId].name;
                else if(nameMapping[rawName]) {
                     const mapped = nameMapping[rawName];
                     if(definedCountries[mapped]) rawName = definedCountries[mapped].name;
                }
                regionInfo.name = rawName;
                const regData = roomData.gameData[selectedId];
                if(regData) regionInfo.status = `Sahibi: ${regData.ownerName}`;
            }

            return (
                <div className="flex h-full w-full relative">
                    <div className="flex-grow bg-blue-200 relative overflow-hidden"
                         onWheel={handleWheel} onMouseDown={startDrag} onMouseMove={doDrag} onMouseUp={stopDrag} onMouseLeave={stopDrag}
                         style={{cursor: isDragging ? 'grabbing' : 'grab'}}>
                        
                        {!roomData.mapSvg && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/90 z-10">
                                <p className="text-xl mb-4">Harita Bekleniyor...</p>
                                {isHost && <label className="bg-yellow-600 px-4 py-2 rounded cursor-pointer font-bold hover:bg-yellow-500 transition">
                                    Harita Y√ºkle (.svg)
                                    <input type="file" accept=".svg,.txt" onChange={handleMap} style={{display:'none'}}/>
                                </label>}
                            </div>
                        )}

                        <div style={{ transform: `translate(${pos.x}px, ${pos.y}px) scale(${scale})`, transformOrigin: '0 0' }} className="w-full h-full">
                            {roomData.mapSvg && <div ref={svgRef} dangerouslySetInnerHTML={{__html: roomData.mapSvg}} className="w-full h-full"/>}
                        </div>

                        <div className="absolute top-4 left-4 bg-gray-900/80 p-3 rounded flex gap-4 pointer-events-auto backdrop-blur shadow-lg text-white">
                            <div><div className="text-xs text-gray-400">ODA</div><div className="font-bold text-yellow-400 text-xl flex items-center gap-2">{roomCode} <Copy size={14} className="cursor-pointer hover:text-white" onClick={() => navigator.clipboard.writeText(roomCode)}/></div></div>
                            <div className="w-px bg-gray-600"></div>
                            <div><div className="text-xs text-gray-400">Kƒ∞≈ûƒ∞</div><div className="font-bold flex items-center gap-1"><Users size={16}/> {Object.keys(roomData.players).length}</div></div>
                            <button onClick={leaveRoom} className="text-red-400 hover:text-red-300 font-bold text-sm ml-2" title="√áƒ±kƒ±≈ü"><LogOut size={18}/></button>
                        </div>
                    </div>

                    <div className="w-80 bg-gray-800 flex flex-col border-l border-gray-700 shadow-xl z-20">
                        <div className="flex border-b border-gray-700">
                            <button onClick={()=>setTab('chat')} className={`flex-1 p-3 font-bold text-sm flex items-center justify-center gap-1 ${tab==='chat'?'bg-gray-700 text-white':'text-gray-400 hover:bg-gray-750'}`}><MessageSquare size={16}/> SOHBET</button>
                            <button onClick={()=>setTab('game')} className={`flex-1 p-3 font-bold text-sm flex items-center justify-center gap-1 ${tab==='game'?'bg-gray-700 text-white':'text-gray-400 hover:bg-gray-750'}`}><Shield size={16}/> OYUN</button>
                        </div>

                        <div className="flex-grow overflow-y-auto p-4 relative">
                            {tab === 'chat' ? (
                                <div className="flex flex-col h-full">
                                    <div className="flex-grow space-y-2 mb-4 overflow-y-auto pr-1 custom-scrollbar">
                                        {roomData.chat?.map((m, i) => (
                                            <div key={i} className="bg-gray-700/50 p-2 rounded border-l-4" style={{borderColor: m.color}}>
                                                <div className="flex justify-between items-end mb-1">
                                                    <div className="text-xs font-bold" style={{color: m.color}}>{m.sender}</div>
                                                    <div className="text-[10px] text-gray-500">{new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                                                </div>
                                                <div className="text-sm text-gray-200 break-words">{m.text}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <form onSubmit={sendMsg} className="mt-auto flex gap-2">
                                        <input value={msg} onChange={e=>setMsg(e.target.value)} className="flex-1 bg-gray-900 rounded px-3 py-2 text-sm outline-none border border-gray-600 focus:border-yellow-500 text-white" placeholder="Mesaj..." />
                                        <button className="bg-blue-600 px-3 rounded text-white hover:bg-blue-500"><Send size={16}/></button>
                                    </form>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="bg-gray-700 p-3 rounded border border-gray-600 shadow-sm">
                                        <h3 className="text-xs text-gray-400 font-bold mb-2 uppercase flex justify-between">
                                            <span>Durumum</span>
                                            <span className="flex items-center gap-1" style={{color: me.color}}>
                                                <div className="w-3 h-3 rounded-full" style={{backgroundColor: me.color}}></div>
                                            </span>
                                        </h3>
                                        <div className="flex justify-between font-bold text-yellow-400 mb-1"><span>üí∞ Kasa:</span> <span>{me.money}</span></div>
                                        <div className="flex justify-between font-bold text-red-400"><span>‚öîÔ∏è Asker:</span> <span>{me.soldiers}</span></div>
                                    </div>

                                    <div className="bg-gray-700 p-3 rounded border border-gray-600 min-h-[120px] shadow-sm">
                                        <h3 className="text-xs text-gray-400 font-bold mb-2 uppercase">Se√ßili B√∂lge</h3>
                                        {selectedId ? (
                                            <div>
                                                <div className="text-lg font-bold mb-1 text-white">{regionInfo.name}</div>
                                                <div className="text-xs text-gray-400 mb-3">{regionInfo.status}</div>
                                                {(!roomData.gameData[selectedId] || roomData.gameData[selectedId].owner !== user.uid) ? (
                                                    <button onClick={buyRegion} className="w-full bg-green-600 hover:bg-green-500 py-2 rounded font-bold text-sm text-white transition">Satƒ±n Al (10k)</button>
                                                ) : <div className="text-center text-green-400 border border-green-500/30 py-2 rounded text-sm font-bold bg-green-500/10">B√∂lge Sizin</div>}
                                            </div>
                                        ) : <div className="text-gray-500 text-center py-4 italic">Haritadan se√ßin</div>}
                                    </div>

                                    <div className="bg-gray-700 p-3 rounded border border-gray-600 shadow-sm">
                                        <h3 className="text-xs text-gray-400 font-bold mb-2 uppercase">Oyuncular</h3>
                                        <div className="space-y-2">
                                            {Object.values(roomData.players).map(p => (
                                                <div key={p.id} className="flex justify-between items-center bg-gray-800 p-2 rounded border-l-4 shadow-sm" style={{borderColor: p.color}}>
                                                    <span className="text-sm font-bold" style={{color:p.color}}>{p.name}</span>
                                                    {p.id === user.uid && <span className="text-[10px] bg-gray-600 px-1.5 py-0.5 rounded text-gray-200">SEN</span>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>